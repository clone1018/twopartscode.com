<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Waffle with Phoenix Controllers - Two Parts Code</title><meta name=keywords content><meta name=description content="Ingredients  Elixir 1.11.1 PostgreSQL 13.0 Phoenix 1.5.6 Waffle 1.1.3 Waffle Ecto 0.0.9  In this tutorial we&rsquo;ll be showing you how to use Waffle and Waffle Ecto directly inside a traditional Phoenix Controller based application, our next guide covers how to use it more magically with Phoenix LiveView. Our example project will be a simple file upload tool users can use to store plain text files and images. If you are interested in using Waffle without Waffle Ecto, you&rsquo;ll just need to omit the imports and handle the state saving yourself."><meta name=author content><link rel=canonical href=https://twopartscode.com/elixir/waffle/with-phoenix-controllers/><link href=https://twopartscode.com/assets/css/stylesheet.min.5d44456813d58b9cb020e3474e4c5d14b03070ef2a1e81ef3a4de94a1bc6696b.css integrity="sha256-XURFaBPVi5ywIONHTkxdFLAwcO8qHoHvOk3pShvGaWs=" rel="preload stylesheet" as=style><link rel=apple-touch-icon href=https://twopartscode.com/apple-touch-icon.png><link rel=icon href=https://twopartscode.com/favicon.ico><meta name=generator content="Hugo 0.77.0"></head><body class=single id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else{if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}}</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://twopartscode.com/ accesskey=h>Two Parts Code</a>
<span class=logo-switches><span class=theme-toggle><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Waffle with Phoenix Controllers</h1><div class=post-meta>October 30, 2020</div></header><div class=toc><details><summary><div class=details accesskey=c>Table of Contents</div></summary><blockquote><ul><ul><ul><li><a href=#ingredients>Ingredients</a></li><li><a href=#previous-article>Previous Article</a></li></ul><li><a href=#phoenix-setup>Phoenix Setup</a><ul><li><a href=#bootstrap-some-html>Bootstrap some HTML</a></li></ul></li><li><a href=#waffle-setup>Waffle Setup</a><ul><li><a href=#setup-the-waffle-storage-provider>Setup the Waffle Storage Provider</a></li><li><a href=#setup-your-endpointex-to-handle-the-uploads>Setup your endpoint.ex to handle the uploads</a></li><li><a href=#define-the-waffle-definition>Define the Waffle Definition</a></li><li><a href=#simplest-plain-text-file-upload>Simplest plain text file upload</a></li></ul></li></ul><li><a href=#todo>Todo</a><ul><li><a href=#uploading-from-the-browser>Uploading From the Browser</a></li><li><a href=#todo-1>TODO</a></li></ul></li></ul></blockquote></details></div><div class=post-content><h3 id=ingredients>Ingredients</h3><ul><li>Elixir 1.11.1</li><li>PostgreSQL 13.0</li><li>Phoenix 1.5.6</li><li>Waffle 1.1.3</li><li>Waffle Ecto 0.0.9</li></ul><p>In this tutorial we&rsquo;ll be showing you how to use Waffle and Waffle Ecto directly inside a traditional Phoenix Controller based application, our next guide covers how to use it more magically with Phoenix LiveView. Our example project will be a simple file upload tool users can use to store plain text files and images. If you are interested in using Waffle without Waffle Ecto, you&rsquo;ll just need to omit the imports and handle the state saving yourself.</p><blockquote><h3 id=previous-article>Previous Article</h3><p>If you&rsquo;re looking for a quick intro to Waffle, please check out <a href=/elixir/waffle/introduction-to-waffle>Introduction to Waffle</a>.</p></blockquote><h2 id=phoenix-setup>Phoenix Setup</h2><h3 id=bootstrap-some-html>Bootstrap some HTML</h3><p>This step is optional if you are adding a Waffle Upload to an existing form or schema.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Use Phoenix to generate some HTML scaffolding for us. We&#39;ll call </span>
<span style=color:#75715e># the context Uploads -- since we&#39;ll be storing images later as well, </span>
<span style=color:#75715e># and we&#39;ll call the individual models a File.</span>
<span style=color:#75715e>#</span>
<span style=color:#75715e># Fields:</span>
<span style=color:#75715e># file - We&#39;ll be using the file field to store the actual string </span>
<span style=color:#75715e>#        representation of the waffle upload. Waffle will translate </span>
<span style=color:#75715e>#        this back into a servable file as well. Use a string type </span>
<span style=color:#75715e>#        so Waffle can save it correctly.</span>
<span style=color:#75715e># description - A short description of the file</span>
$ mix phx.gen.html Uploads File files file:string description:string 
</code></pre></div><p>After you generate the HTML, make sure you follow the steps to add the route and migrate the database.</p><p><img src=/uploads/elixir/waffle/scaffolding-file-list.png alt="Phoenix Scaffolding File List">
<img src=/uploads/elixir/waffle/scaffolding-new-file.png alt="Phoenix Scaffolding New File"></p><h2 id=waffle-setup>Waffle Setup</h2><h3 id=setup-the-waffle-storage-provider>Setup the Waffle Storage Provider</h3><p>In order to use Waffle in any capacity you&rsquo;ll need to setup the storage provider in one of your configs. A common location for your dev environment is <code>config/dev.exs</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#75715e># config/dev.exs</span>
...

<span style=color:#75715e># Configure Waffle to store all uploads in a local filesystem location.</span>
config <span style=color:#e6db74>:waffle</span>,
  <span style=color:#e6db74>storage</span>: <span style=color:#a6e22e>Waffle.Storage.Local</span>
</code></pre></div><h3 id=setup-your-endpointex-to-handle-the-uploads>Setup your endpoint.ex to handle the uploads</h3><p>Anytime you&rsquo;re using the local storage method with waffle and not otherwise handling the assets with some other webserver (like nginx) you&rsquo;ll need to configure your <code>endpoint.ex</code> to allow for the static assets to be served.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#75715e># lib/waffle_example_web/endpoint.ex</span>
<span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>WaffleExampleWeb.Endpoint</span> <span style=color:#66d9ef>do</span>
    ...

    <span style=color:#75715e># Make your /uploads dir available to any web clients. </span>
    <span style=color:#75715e># Don&#39;t replace your existing Plug.Static, as this </span>
    <span style=color:#75715e># will just be supplemental.</span>
    plug <span style=color:#a6e22e>Plug.Static</span>,
        <span style=color:#75715e># Accepts web requests at example.com/uploads</span>
        <span style=color:#e6db74>at</span>: <span style=color:#e6db74>&#34;/uploads&#34;</span>,
        <span style=color:#75715e># Looks for the file anywhere in waffle_example/uploads</span>
        <span style=color:#e6db74>from</span>: <span style=color:#a6e22e>Path</span><span style=color:#f92672>.</span>expand(<span style=color:#e6db74>&#34;./uploads&#34;</span>),
        <span style=color:#e6db74>gzip</span>: <span style=color:#66d9ef>false</span>

    ...
<span style=color:#66d9ef>end</span>
</code></pre></div><h3 id=define-the-waffle-definition>Define the Waffle Definition</h3><p>A Waffle Definition defines an interface for your upload to automatically work with, so you are not doing your validation & transformations outside of your business logic code. With Phoenix, it makes the most sense to store these files in <code>lib/waffle_example_web/uploads/</code> to keep them in a single location. I choose the <code>_web</code> directory because Waffle exists to translate a web http upload into a file on your system, and then your business logic can do whatever it wants with that file.</p><h3 id=simplest-plain-text-file-upload>Simplest plain text file upload</h3><p>Like I mentioned before, Waffle can be configured to be very feature-full and powerful, or you can use it in less lines than your entire Ecto Schema you store it in.</p><p>You can generate an Waffle Definition using <code>mix waffle.g text_file</code> or simply create a new file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#75715e># lib/waffle_example_web/uploaders/text_file_upload.ex</span>
<span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>WaffleExampleWeb.TextFileUpload</span> <span style=color:#66d9ef>do</span>
  <span style=color:#f92672>use</span> <span style=color:#a6e22e>Waffle.Definition</span>
  <span style=color:#f92672>use</span> <span style=color:#a6e22e>Waffle.Ecto.Definition</span>

  <span style=color:#a6e22e>@extension_whitelist</span> <span style=color:#e6db74>~w(.txt)</span>

  <span style=color:#75715e># The validate function is also optional :)</span>
  <span style=color:#66d9ef>def</span> validate({file, _}) <span style=color:#66d9ef>do</span>
    file_extension <span style=color:#f92672>=</span> file<span style=color:#f92672>.</span>file_name <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>Path</span><span style=color:#f92672>.</span>extname <span style=color:#f92672>|&gt;</span> <span style=color:#a6e22e>String</span><span style=color:#f92672>.</span>downcase
    <span style=color:#a6e22e>Enum</span><span style=color:#f92672>.</span>member?(<span style=color:#a6e22e>@extension_whitelist</span>, file_extension)
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>
</code></pre></div><p>You also need to update your Ecto Schema to utilize the Waffle File definition we created.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#75715e># lib/waffle_example/uploads/file.ex</span>
<span style=color:#66d9ef>defmodule</span> <span style=color:#a6e22e>WaffleExample.Uploads.File</span> <span style=color:#66d9ef>do</span>
  ... 
  <span style=color:#75715e># Use the Waffle Ecto Schema</span>
  <span style=color:#f92672>use</span> <span style=color:#a6e22e>Waffle.Ecto.Schema</span>

  schema <span style=color:#e6db74>&#34;files&#34;</span> <span style=color:#66d9ef>do</span>
    field <span style=color:#e6db74>:description</span>, <span style=color:#e6db74>:string</span>
    <span style=color:#75715e># Change the existing file field definition to point to the </span>
    <span style=color:#75715e># Waffle definition&#39;s built-in `Type` definition.</span>

    <span style=color:#75715e># field :file, :string -- original field definition</span>
    field <span style=color:#e6db74>:file</span>, <span style=color:#a6e22e>WaffleExampleWeb.TextFileUpload.Type</span> 

    timestamps()
  <span style=color:#66d9ef>end</span>

  ...

  <span style=color:#75715e># Modify your changesets to cast the file from a %Plug.Upload{} </span>
  <span style=color:#66d9ef>def</span> changeset(file, attrs) <span style=color:#66d9ef>do</span>
    file
    <span style=color:#75715e># Remove the :file from the cast, because you handle it below</span>
    <span style=color:#75715e># |&gt; cast(attrs, [:file, :description])</span>
    <span style=color:#f92672>|&gt;</span> cast(attrs, [<span style=color:#e6db74>:description</span>])
    <span style=color:#75715e># Add a new cast_attachments call provided by Waffle.Ecto.Schema</span>
    <span style=color:#f92672>|&gt;</span> cast_attachments(attrs, [<span style=color:#e6db74>:file</span>])
    <span style=color:#f92672>|&gt;</span> validate_required([<span style=color:#e6db74>:file</span>, <span style=color:#e6db74>:description</span>])
  <span style=color:#66d9ef>end</span>

  ...
<span style=color:#66d9ef>end</span>
</code></pre></div><p>After you&rsquo;ve done that Ecto now knows how to treat any file uploads. Behind the scenes <a href=https://github.com/elixir-waffle/waffle_ecto/blob/72e9843d860a1ff0dd7588e27f7c8b4aae827d70/lib/waffle_ecto/schema.ex#L92>waffle_ecto is checking for any matching pattern</a> to cast into the changeset.</p><p>It&rsquo;s worth mentioning that the cast_attachments can also handle remote files by using a similar syntax</p><h1 id=todo>Todo</h1><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>changeset 
<span style=color:#f92672>|&gt;</span> cast_attachments(attrs, [<span style=color:#e6db74>:fetched_remote_file</span>], <span style=color:#e6db74>allow_urls</span>: <span style=color:#66d9ef>true</span>)

</code></pre></div><h2 id=uploading-from-the-browser>Uploading From the Browser</h2><p>Surprisingly, you don&rsquo;t need to modify any of your controller logic for Phoenix, since they are only used for translating the web request to the domain logic. Since you are not changing the structure, just the types, you can skip the controller actions.</p><p>What you do need to do however, is update the generated <code>form.html.eex</code> to use a file upload input type instead of a text input type. Phoenix provides helpers for this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir>  <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>=</span> label f, <span style=color:#e6db74>:file</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>&gt;</span>
  <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>=</span> file_input f, <span style=color:#e6db74>:file</span>, <span style=color:#e6db74>accept</span>: <span style=color:#e6db74>&#34;plain/text&#34;</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>&gt;</span>
  <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>=</span> error_tag f, <span style=color:#e6db74>:file</span> <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>&gt;</span>
</code></pre></div><p>If you made the change successfully you should now have a page with an file input form and a description. The final test is to try and upload a text file of your choosing!</p><p><img src=/uploads/elixir/waffle/waffle-new-file.png alt="Waffle New File"></p><p>Using the file either by showing it to users, or offering to download it is extremely simple as well. Simply by calling the <code>url</code> function you can get the path.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elixir data-lang=elixir><span style=color:#75715e># Will output /uploads/your-text-file.txt</span>
<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>WaffleExampleWeb.TextFileUpload</span><span style=color:#f92672>.</span>url(file<span style=color:#f92672>.</span>file) <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>&gt;</span>

<span style=color:#75715e># Will output http://localhost:4000/uploads/your-text-file.txt</span>
<span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>=</span> <span style=color:#a6e22e>Routes</span><span style=color:#f92672>.</span>static_url(<span style=color:#a6e22e>@conn</span>, <span style=color:#a6e22e>WaffleExampleWeb.TextFileUpload</span><span style=color:#f92672>.</span>url(file<span style=color:#f92672>.</span>file)) <span style=color:#960050;background-color:#1e0010>%</span><span style=color:#f92672>&gt;</span>
</code></pre></div><h2 id=todo-1>TODO</h2><p>Some final wrap up&mldr;.</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2020 <a href=https://twopartscode.com/>Two Parts Code</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top" accesskey=g><button class=top-link id=top-link type=button><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6"><path d="M12 6H0l6-6z"/></svg></button></a>
<script src=https://twopartscode.com/assets/js/highlight.min.e7afc2928c0925d65c4732dfebe147014d91299a98e819e4b42f25c4fa68e91c.js integrity="sha256-56/CkowJJdZcRzLf6+FHAU2RKZqY6BnktC8lxPpo6Rw="></script><script>hljs.initHighlightingOnLoad();</script><script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);document.querySelector(`[id='${id}']`).scrollIntoView({behavior:"smooth"});});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>